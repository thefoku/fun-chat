(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class b{constructor(){this.app=document.createElement("div"),this.app.id="app"}create(){this.removeChildren(),document.body.append(this.app)}append(...e){for(let t of e)this.app.append(t)}getElement(){return this.app}removeChildren(){const e=this.app.childNodes;if(e.length>0)for(let t of e)this.app.removeChild(t)}}const c=new b;class f{constructor(e,t,s){this.isDisabled=!1,this.element=document.createElement("button"),this.element.setAttribute("id",e),this.element.innerText=t,this.element.addEventListener("click",s)}appendTo(e){e.appendChild(this.element)}innerText(e){this.element.innerText=e}getElement(){return this.element}disable(){this.isDisabled?this.isDisabled=!1:this.isDisabled=!0,this.element.disabled=this.isDisabled}setClass(e){this.element.classList.add(e)}setAttribute(e,t){this.element.setAttribute(e,t)}}class C{constructor(){this.main=document.createElement("main"),this.main.classList.add("main")}appendTo(e){e.appendChild(this.main)}append(...e){for(let t of e)this.main.append(t)}getElement(){return this.main}}class R{constructor(){this.main=new C,this.h1=document.createElement("h1"),this.h1.textContent="Error Page",this.h2=document.createElement("h2"),this.h2.innerText="This page doesn't exist. Click 'Go back' to return back.",this.h2.classList.add("error-message"),this.router=new g,this.main.append(this.h1,this.h2)}removeBody(){document.body.remove(),document.body=document.createElement("body")}render(){document.title="Fun Chat - Error";const e=new f("backHome","Go back",()=>{this.router.goBack()});c.create(),this.main.append(e.getElement()),c.append(this.main.getElement())}}class v{constructor(e,t,s,i,n,o){this.div=document.createElement("div"),this.div.classList.add(i),this.label=document.createElement("label"),this.label.textContent=t,this.label.setAttribute("for",e),this.input=document.createElement("input"),this.input.type=s,this.input.id=e,s.toLowerCase()==="text"&&(this.input.autocomplete="name"),s.toLowerCase()==="password"&&(this.input.autocomplete="new-password"),n&&(this.input.required=!0),o&&(this.input.placeholder=o),s.toLowerCase()==="submit"?(this.input.value=t,this.input.textContent=t,this.div.append(this.input)):this.div.append(this.label,this.input)}getElement(){return this.div}getInput(){return this.input}}class B{constructor(){this.errorContainer=document.createElement("div"),this.errorContainer.className="error-container",this.errorText=document.createElement("p"),this.errorText.className="error-message",this.errorContainer.append(this.errorText)}clearErrors(e,t){this.errorText.textContent="",e.classList.remove("input-error"),t.classList.remove("input-error")}showError(e){this.errorText.textContent=e}showSuccess(e){this.errorText.textContent=e}getElement(){return this.errorContainer}}const h=new B;function I(r,e,t){const s={login:r,password:e,isLogined:t};sessionStorage.setItem("fun-chat",JSON.stringify(s))}function S(){const r=sessionStorage.getItem("fun-chat");if(r){const{login:e,password:t,isLogined:s}=JSON.parse(r);return{login:e,password:t,isLogined:s}}return null}class M{constructor(){this.div=document.createElement("div"),this.div.classList.add("modal"),this.div.classList.add("hidden"),this.span=document.createElement("span"),this.div.append(this.span),this.line=document.createElement("div"),this.line.classList.add("modal-line"),this.div.append(this.line)}append(e){this.div.append(e)}showWithText(e){this.span.innerText=e,this.div.classList.remove("hidden");let t=100;const s=setInterval(()=>{t-=10,this.line.style.width=`${t}%`,t<0&&(clearInterval(s),this.div.classList.add("hidden"),this.line.style.width="100%")},300)}getElement(){return this.div}getLine(){return this.line}}const w=new M,m=class m{constructor(){console.log("usersList init"),this.div=document.createElement("div"),this.div.classList.add("user-list-wrapper"),this.ul=document.createElement("ul"),this.ul.classList.add("user-list"),this.search=new v("user-search","Search: ","text","user-search",!1,"Search user..."),this.search.getInput().addEventListener("input",()=>this.handleSearch()),this.div.append(this.search.getElement(),this.ul)}getElement(){return this.div}append(e){this.ul.append(e)}getChildren(){return this.ul.children}clear(){m.Users.length=0,this.ul.replaceChildren()}isInclude(e){for(let t of m.Users)if(e===t.getUsername())return!0;return!1}handleSearch(){var t;const e=this.search.getInput().value;for(let s of this.ul.children)(t=s.textContent)!=null&&t.toLowerCase().includes(e.toLowerCase())?s.classList.remove("hidden"):s.classList.add("hidden");console.log(e)}setStatus(e,t){for(let s of m.Users)e===s.getUsername()&&(t?s.getElement().classList.add("online"):s.getElement().classList.remove("online"))}};m.Users=[];let u=m;const L=new u;class T{constructor(){this.isShown=!1,this.div=document.createElement("div"),this.div.classList.add("divider"),this.text=document.createElement("p"),this.text.textContent="New messages.",this.text.classList.add("divider-text"),this.div.append(this.text)}getElement(){return this.div}appendTo(e){this.isShown||e.append(this.div),this.isShown=!0}remove(){this.isShown=!1,this.div.remove()}}const y=new T;class k{constructor(){this.selectedMessage=null,this.ul=document.createElement("ul"),this.ul.classList.add("message-context-menu"),this.edit=document.createElement("li"),this.edit.classList.add("message-context-menu-item"),this.edit.textContent="Edit message",this.delete=document.createElement("li"),this.delete.classList.add("message-context-menu-item"),this.delete.textContent="Delete message",this.ul.append(this.edit,this.delete),document.addEventListener("click",e=>{(e.target!==this.ul||e.target!==this.edit||e.target!==this.delete)&&(this.hideElement(),this.selectedMessage=null)}),this.edit.addEventListener("click",()=>{var e;console.log(this.selectedMessage),d.editMessage((e=this.selectedMessage)==null?void 0:e.getMessageText()),d.editingMessage=this.selectedMessage}),this.delete.addEventListener("click",()=>{var e;a.deleteMessageRequest((e=this.selectedMessage)==null?void 0:e.getId())})}showOnElement(e){console.log(this),this.selectedMessage=e,e.append(this.ul)}hideElement(){this.ul.remove()}}const N=new k,U=class U{constructor(e,t,s,i,n){this.isReaded=!1,this.isDelivered=!1,this.isEdited=!1,this.id=s,this.wrapper=document.createElement("div"),this.wrapper.classList.add("message-wrapper"),this.div=document.createElement("div"),this.div.classList.add("message"),a.currentUser!==t?this.wrapper.classList.add("received"):this.wrapper.classList.add("sent"),this.header=document.createElement("div"),this.header.classList.add("message-header"),this.username=document.createElement("p"),this.username.textContent=t,this.time=document.createElement("p"),i?this.time.textContent=new Date(i).toLocaleString("en-GB"):this.time.textContent=new Date().toLocaleString("en-GB"),this.text=document.createElement("div"),this.text.classList.add("message-text"),this.text.textContent=e,this.footer=document.createElement("div"),this.footer.classList.add("message-footer"),this.status=document.createElement("p"),this.status.classList.add("message-status"),n&&n.isDelivered?(this.status.textContent="Delivered",this.isDelivered=!0):this.status.textContent="Sent",n!=null&&n.isReaded&&(this.status.textContent="Read",this.isReaded=!0),this.edited=document.createElement("p"),this.edited.classList.add("message-status-edited"),n!=null&&n.isEdited&&(this.setEditedStatus(),this.isEdited=!0),this.footer.append(this.edited),this.header.append(this.username,this.time),t===a.currentUser&&this.footer.append(this.status),this.div.append(this.header,this.text,this.footer),this.wrapper.append(this.div),d.appendToChat(this.wrapper),U.messages.push(this),d.scrollToBottom(),this.div.addEventListener("contextmenu",o=>{o.preventDefault(),this.username.textContent===a.currentUser&&N.showOnElement(this)})}getElement(){return this.div}append(e){this.wrapper.append(e)}getId(){return this.id}updateStatus(e){this.status.textContent=e}setEditedStatus(){this.edited.textContent="Edited"}getMessageText(){return this.text.textContent}setMessageText(e){this.text.textContent=e}remove(){this.wrapper.remove()}};U.messages=[];let l=U;function E(){for(let r of u.Users)if(r.getUsername()===a.targetUser){r.clearNotification(),y.remove();for(let e of l.messages)e.isReaded||a.changeStatusToRead(e)}y.remove()}class O{constructor(){this.isEditing=!1,this.editingMessage=null,this.isScrollable=!1,this.div=document.createElement("div"),this.div.classList.add("chat-window-wrapper"),this.chatHeader=document.createElement("div"),this.chatHeader.classList.add("chat-window-header"),this.chatBody=document.createElement("div"),this.chatBody.classList.add("chat-window-body"),this.emptyMessage=document.createElement("p"),this.emptyMessage.textContent="Select user to start chatting",this.emptyMessage.classList.add("chat-window-body_empty-message"),this.spacer=document.createElement("div"),this.spacer.classList.add("chat-spacer"),this.chatInput=document.createElement("form"),this.chatInput.classList.add("chat-window-input"),this.chatInput.addEventListener("submit",e=>{e.preventDefault()}),this.chatUsername=document.createElement("p"),this.chatUsername.classList.add("chat-window-header-username"),this.chatStatus=document.createElement("p"),this.chatStatus.classList.add("chat-window-header-status"),this.chatHeader.append(this.chatUsername,this.chatStatus),this.textarea=document.createElement("textarea"),this.textarea.classList.add("message-field"),this.textarea.placeholder="Write a message...",this.textarea.disabled=!0,this.textarea.addEventListener("input",()=>{this.textarea.value.trim().length>0&&a.targetUser?this.sendBtn.getElement().disabled=!1:this.sendBtn.getElement().disabled=!0}),this.textarea.addEventListener("change",()=>{console.log(this.textarea.value)}),this.cancelBtn=document.createElement("p"),this.cancelBtn.classList.add("chat-input-cancel-btn"),this.cancelBtn.textContent="Cancel",this.cancelBtn.addEventListener("click",()=>{this.cancelEditMessage()}),this.sendBtn=new f("sendBtn","Send",()=>{this.handleSendBtn()}),this.chatBody.addEventListener("click",()=>{E()}),this.chatBody.addEventListener("contextmenu",()=>{E()}),this.chatBody.addEventListener("wheel",()=>{E()}),document.addEventListener("keypress",e=>{e.key==="Enter"&&this.chatInput&&this.textarea.value.trim().length>0&&a.targetUser&&(this.handleSendBtn(),console.log("enter is pressed to send message"))}),this.sendBtn.getElement().disabled=!0,this.chatInput.append(this.textarea,this.sendBtn.getElement()),this.chatBody.append(this.spacer,this.emptyMessage),this.div.append(this.chatHeader,this.chatBody,this.chatInput)}getElement(){return this.div}getBody(){return this.chatBody}appendToChat(...e){for(let t of e)this.chatBody.append(t)}editMessage(e){this.setMessageText(e),this.isEditing=!0,this.chatInput.append(this.cancelBtn)}cancelEditMessage(){this.clearInput(),this.isEditing=!1,this.cancelBtn.remove(),setTimeout(()=>{this.sendBtn.getElement().disabled=!0})}createMessage(e){this.chatBody.scrollTop=this.chatBody.scrollHeight,a.sendMessage(a.targetUser,e),this.scrollToBottom()}scrollToBottom(){const e=()=>{this.isScrollable=!0,this.chatBody.removeEventListener("scrollend",e)};setTimeout(()=>{this.chatBody.scrollTo(0,this.chatBody.scrollHeight),this.chatBody.addEventListener("scrollend",e)},100)}setMessageText(e){this.textarea.value=e,this.sendBtn.getElement().disabled=!1}clearInput(){this.textarea.value="",this.sendBtn.getElement().disabled=!0}clearSelectedUser(){this.chatUsername.textContent="",this.chatStatus.textContent="",this.emptyMessage.textContent="Select user to start chatting",this.chatBody.append(this.emptyMessage)}unlockInput(){this.textarea.disabled=!1}showNoMessagesText(){this.emptyMessage.textContent="Your chat history is empty. Let' start chatting!",this.chatBody.append(this.emptyMessage)}handleSendBtn(){var e;this.isEditing?(a.editMessageRequest((e=this.editingMessage)==null?void 0:e.getId(),this.textarea.value),this.cancelEditMessage(),setTimeout(()=>{this.textarea.value=""})):(this.createMessage(this.textarea.value),E(),setTimeout(()=>{this.textarea.value="",this.sendBtn.getElement().disabled=!0}),console.log(this.isEditing))}appendSpacer(){this.chatBody.append(this.spacer)}removeEmptyMessage(){this.emptyMessage.remove()}clearChat(){this.isScrollable=!1;const e=this.chatBody.children;this.removeEmptyMessage();for(let t of e)t!==e[0]&&setTimeout(()=>{this.chatBody.removeChild(t)},0)}setUsername(e,t){this.chatUsername.textContent=e,t?(this.chatStatus.textContent="online",this.chatStatus.classList.add("online")):(this.chatStatus.textContent="offline",this.chatStatus.classList.remove("online"))}}const d=new O;class x{constructor(e,t){this.numberOfUnreadMessages=0,this.unreadMessagesId=[],this.li=document.createElement("li"),this.li.classList.add("user-list-item"),t&&this.li.classList.add("online"),this.status=document.createElement("div"),this.status.classList.add("user-list-status"),this.username=document.createElement("p"),this.username.textContent=e,this.li.append(this.status,this.username),this.notification=document.createElement("div"),this.notification.classList.add("user-list-item_notification"),this.appendToUserList(),this.li.addEventListener("click",()=>{y.remove(),d.unlockInput(),d.clearInput(),d.setUsername(this.username.textContent,this.li.className.includes("online")),a.targetUser=this.username.textContent,d.clearChat(),l.messages.length=0,a.requestAllMessagesWith(this.username.textContent),d.scrollToBottom()}),a.requestAllMessagesWith(this.username.textContent)}appendToUserList(){u.Users.push(this),L.append(this.li)}getElement(){return this.li}getUsername(){return this.username.textContent}showNotification(e,t){this.unreadMessagesId.push(t),this.numberOfUnreadMessages+=e,this.notification.textContent=this.numberOfUnreadMessages.toString(),this.li.append(this.notification)}decreaseNotification(e){const t=this.unreadMessagesId;t.length>0&&t.forEach(s=>{s===e&&(this.numberOfUnreadMessages-=1,this.numberOfUnreadMessages===0?this.clearNotification():(this.notification.textContent=this.numberOfUnreadMessages.toString(),t.splice(t.indexOf(s),1),console.log(`Message ${s} was deleted`),console.log("Notification decreased")))})}clearNotification(){this.notification.remove(),this.unreadMessagesId.length=0,this.numberOfUnreadMessages=0}setStatus(e){e?this.status.classList.add("online"):this.status.classList.remove("online")}}class q{constructor(e){this.url=e,this.currentUser=null,this.targetUser=null,this.pendingRequests=new Map,this.socket=new WebSocket(this.url),this.setupEventHandlers()}setupEventHandlers(){this.socket.onopen=()=>{console.log("WebSocket connection established")},this.socket.onmessage=e=>{const t=JSON.parse(e.data);switch(t.type){case"USER_LOGIN":this.handleLoginResponse(t);break;case"USER_LOGOUT":this.handleLogoutResponse(t);case"USER_EXTERNAL_LOGIN":this.handleExternalLoginResponse(t);break;case"USER_EXTERNAL_LOGOUT":this.handleExternalLogout(t);break;case"USER_ACTIVE":this.renderActiveUsers(t);break;case"USER_INACTIVE":this.renderInactiveUsers(t);break;case"MSG_SEND":this.renderNewMessage(t);break;case"MSG_FROM_USER":this.renderMessageHistory(t);break;case"MSG_READ":this.changeMessageStatusToRead(t);break;case"MSG_DELIVER":this.changeMessageStatus(t);break;case"MSG_DELETE":this.deleteMessageResponse(t);break;case"MSG_EDIT":this.editMessageResponse(t);break;case"ERROR":this.handleError(t);break}},this.socket.onclose=()=>{console.log("Connection closed"),this.close()},this.socket.onerror=e=>{console.error("WebSocket error:",e)}}async ensureConnection(){if(this.socket.readyState!==WebSocket.OPEN)return new Promise((e,t)=>{const s=setInterval(()=>{this.socket.readyState===WebSocket.OPEN?(clearInterval(s),e()):this.socket.readyState===WebSocket.CLOSED&&(clearInterval(s),t(new Error("WebSocket connection failed")))},100)})}async authenticate(e,t){if(this.currentUser)throw new Error("Another user is already authenticated in this connection");const s=this.generateRequestId(),i={id:s,type:"USER_LOGIN",payload:{user:{login:e,password:t}}};return new Promise((n,o)=>{this.pendingRequests.set(s,n);try{this.socket.send(JSON.stringify(i))}catch(A){this.pendingRequests.delete(s),o(A),console.log(A)}setTimeout(()=>{this.pendingRequests.has(s)&&(this.pendingRequests.delete(s),o(new Error("Authentication timeout")))},1e5)})}async logout(e,t){const s=this.generateRequestId(),i={id:s,type:"USER_LOGOUT",payload:{user:{login:e,password:t}}};return new Promise((n,o)=>{if(this.socket.readyState!==WebSocket.OPEN){o(new Error("WebSocket connection is not open"));return}this.pendingRequests.set(s,n);try{this.socket.send(JSON.stringify(i)),I("null","null",!1)}catch(A){this.pendingRequests.delete(s),o(A)}})}async deleteMessageRequest(e){const s={id:this.generateRequestId(),type:"MSG_DELETE",payload:{message:{id:e}}};try{this.socket.send(JSON.stringify(s))}catch(i){console.error("Error when deleting message:",i)}}deleteMessageResponse(e){const t=e.payload.message;for(let s of l.messages)s.getId()===t.id&&(s.remove(),l.messages.splice(l.messages.indexOf(s),1));for(let s of u.Users)s.decreaseNotification(t.id);l.messages.length===0&&(d.showNoMessagesText(),console.log("No messages left"))}async editMessageRequest(e,t){const i={id:this.generateRequestId(),type:"MSG_EDIT",payload:{message:{id:e,text:t}}};try{this.socket.send(JSON.stringify(i))}catch(n){console.error("Error when editing message:",n)}}editMessageResponse(e){const t=e.payload.message;for(let s of l.messages)t.id===s.getId()&&(s.setEditedStatus(),s.setMessageText(t.text))}async sendMessage(e,t){if(!this.currentUser)throw new Error("You must be authenticated to send messages");const s=this.generateRequestId(),i={id:s,type:"MSG_SEND",payload:{message:{to:e,text:t}}};return new Promise((n,o)=>{this.pendingRequests.set(s,A=>{A.type==="ERROR"?o(new Error(A.payload.error)):n(A)});try{this.socket.send(JSON.stringify(i))}catch(A){this.pendingRequests.delete(s),o(A)}})}async requestAllMessagesWith(e){const s={id:this.generateRequestId(),type:"MSG_FROM_USER",payload:{user:{login:e}}};try{this.socket.send(JSON.stringify(s))}catch(i){console.log("Error when fetching message history:",i)}}renderMessageHistory(e){const t=e.payload.messages;for(let s of t){if(!s.status.isReaded)for(let i of u.Users)i.getUsername()===s.from&&s.from!==this.targetUser&&i.showNotification(1,s.id);(s.from===this.currentUser&&s.to===this.targetUser||s.to===this.currentUser&&s.from===this.targetUser)&&(console.log(s.status,"message status"),s.to===this.currentUser&&s.from===this.targetUser&&!s.status.isReaded&&(y.appendTo(d.getBody()),console.log("New message appeared")),new l(s.text,s.from,s.id,s.datetime,s.status))}l.messages.length===0&&this.targetUser&&d.showNoMessagesText()}async getActiveUsers(){return this.getUsersList("USER_ACTIVE")}async getInactiveUsers(){return this.getUsersList("USER_INACTIVE")}async getUsersList(e){const t=this.generateRequestId(),s={id:t,type:e,payload:null};return new Promise((i,n)=>{this.pendingRequests.set(t,o=>{if(o.type==="ERROR"){n(new Error(o.payload.error));return}o.type===e?i(o.payload.users):n(new Error(`Unexpected response type: ${o.type}`))});try{this.socket.send(JSON.stringify(s))}catch(o){this.pendingRequests.delete(t),n(o)}})}async changeStatusToRead(e){const s={id:this.generateRequestId(),type:"MSG_READ",payload:{message:{id:e.getId()}}};try{this.socket.send(JSON.stringify(s))}catch(i){console.error("Error when changing message status:",i)}}renderNewMessage(e){const t=e.payload.message;if(l.messages.length===0&&t.to===this.targetUser&&d.removeEmptyMessage(),t.from===this.currentUser&&t.to===this.targetUser||t.to===this.currentUser&&t.from===this.targetUser){const s=new l(t.text,t.from,t.id,t.datetime,t.status);t.to===this.currentUser&&this.changeStatusToRead(s)}else if(t.to!==this.targetUser)for(let s of u.Users)s.getUsername()===t.from&&s.showNotification(1,t.id)}changeMessageStatusToRead(e){const t=e.payload.message;l.messages.forEach(s=>{s.getId()===t.id&&t.status.isReaded&&s.updateStatus("Read")})}changeMessageStatus(e){const t=e.payload.message;l.messages.forEach(s=>{s.getId()===t.id&&t.status.isDelivered&&s.updateStatus("Delivered")})}handleLoginResponse(e){e.type==="USER_LOGIN"&&e.payload.user.isLogined&&(this.currentUser=e.payload.user.login);const t=this.pendingRequests.get(e.id);t&&(t(e),this.pendingRequests.delete(e.id))}handleExternalLoginResponse(e){if(e.type==="USER_EXTERNAL_LOGIN"&&e.payload.user.isLogined){const t=e.payload.user.login;if(console.log("another user logged in:",t),L.getChildren(),L.isInclude(t))for(let s of u.Users)s.getUsername()===t&&s.getElement().classList.add("online");else new x(t,!0);this.targetUser===t&&d.setUsername(t,!0)}}handleExternalLogout(e){if(e.type==="USER_EXTERNAL_LOGOUT"){const t=e.payload.user.login;console.log("another user logged out:",t);for(let s of u.Users)s.getUsername()===t&&s.getElement().classList.remove("online");this.targetUser===t&&d.setUsername(t,!1)}}handleLogoutResponse(e){e.type==="USER_LOGOUT"&&!e.payload.user.isLogined&&(w.showWithText(`Bye, ${this.currentUser}!`),h.showError(`Bye, ${this.currentUser}!`),this.currentUser=null)}renderActiveUsers(e){for(let t of e.payload.users)this.currentUser!==t.login&&new x(t.login,t.isLogined);return e}renderInactiveUsers(e){for(let t of e.payload.users)new x(t.login,t.isLogined);return e}generateRequestId(){return Date.now().toString(36)+Math.random().toString(36).substring(2)}getCurrentUser(){return this.currentUser}close(){this.socket.close()}isAuthenticated(){return!!this.currentUser}isCurrentUser(e){return this.currentUser===e}handleError(e){const t=e.payload.error;console.log(t),h.showError(`Server error: ${t}`)}}const a=new q("ws://127.0.0.1:4000");async function D(r,e){try{const t=await a.authenticate(r,e);if(t.type==="ERROR"){console.error("Authentication failed:",t.payload.error),h.showError(`Error: ${t.payload.error}`);return}if(t.type==="USER_LOGIN"&&t.payload.user.isLogined)return console.log("Successfully authenticated as:",t.payload.user.login),I(r,e,!0),h.showSuccess(`Welcome, ${t.payload.user.login}!`),new g().navigate("/chat"),!0}catch(t){console.error("Authentication error:",t),h.showError(t instanceof Error?t.message:"Unknown error");return}}async function P(r,e){try{const t=await a.logout(r,e);if(t.type==="ERROR"){console.error("Logout failed:",t.payload.error),h.showError(t.payload.error);return}t.type==="USER_LOGOUT"&&!t.payload.user.isLogined&&(console.log("Successfully logged out:",t.payload.user.login),h.showSuccess(`Goodbye, ${t.payload.user.login}!`))}catch(t){console.error("Logout error:",t),h.showError(t instanceof Error?t.message:"Unknown error")}finally{}}class G{constructor(e,t){this.form=document.createElement("form"),this.form.classList.add(`${e}-form`),this.errorContainer=h,this.nameInput=new v("name","Username: ","text","input-username",!0,"Username"),this.nameInput.getInput().addEventListener("input",()=>{this.validateUsername()}),this.passInput=new v("password","Password: ","password","input-password",!0,"Password"),this.passInput.getInput().addEventListener("input",()=>{this.validatePassword()});const s=S();this.submit=new v(`${e}Btn`,t,"submit","submit-button",!1),this.submit.getElement().addEventListener("click",i=>{i.preventDefault(),this.isValid()?D(this.nameInput.getInput().value,this.passInput.getInput().value):(this.validateUsername(),this.validatePassword())}),s&&s.isLogined&&(this.nameInput.getInput().value=s.login,this.passInput.getInput().value=s.password),this.form.append(this.errorContainer.getElement(),this.nameInput.getElement(),this.passInput.getElement(),this.submit.getElement())}validateUsername(){const e=this.nameInput.getInput().value.trim();return e?e.length<4?(h.showError("Username must be at least 4 characters"),this.nameInput.getElement().classList.add("input-error"),!1):(h.clearErrors(this.nameInput.getElement(),this.passInput.getElement()),!0):(h.showError("Username is required"),this.nameInput.getElement().classList.add("input-error"),!1)}validatePassword(){const e=this.passInput.getInput().value.trim();return e?e.length<6?(h.showError("Password must be at least 6 characters"),this.passInput.getElement().classList.add("input-error"),!1):/[A-Z]/.test(e)?/[a-zA-Z]/.test(e)?(h.clearErrors(this.nameInput.getElement(),this.passInput.getElement()),!0):(h.showError("Password must contain at least one letter"),this.passInput.getElement().classList.add("input-error"),!1):(h.showError("Password must contain at least one uppercase letter"),this.passInput.getElement().classList.add("input-error"),!1):(h.showError("Password is required"),this.passInput.getElement().classList.add("input-error"),!1)}isValid(){const e=this.validateUsername(),t=this.validatePassword();return e&&t?(console.log("Form is valid!"),!0):!1}append(...e){for(let t of e)this.form.append(t)}getElement(){return this.form}getNameInput(){return this.nameInput}getPassInput(){return this.passInput}}const F=new G("login","Login");class J{constructor(){c.create(),this.div=document.createElement("div"),this.div.classList.add("login-wrapper"),this.heading=document.createElement("h1"),this.heading.textContent="Login page",this.aboutBtn=new f("aboutBtn","About",()=>{new g().navigate("/about")}),this.div.append(this.heading)}render(){document.title="Fun Chat - Login",c.create(),c.removeChildren();const e=S();if(e!=null&&e.isLogined){c.removeChildren(),setTimeout(()=>{new g().navigate("/chat")});return}const t=F;this.div.append(t.getElement(),this.aboutBtn.getElement()),c.append(this.div),c.append(w.getElement())}}class W{constructor(){c.create(),this.div=document.createElement("div"),this.div.classList.add("login-wrapper"),this.heading=document.createElement("h1"),this.heading.textContent="About",this.link=document.createElement("a"),this.link.href="https://github.com/thefoku",this.link.target="_blank",this.link.textContent="thefoku",this.paragraph=document.createElement("p"),this.paragraph.classList.add("about-text"),this.paragraph.textContent="This Fun Chat app was developed by ",this.paragraph.append(this.link),this.homeButton=new f("homeBtn","Back",()=>{new g().goBack()}),this.div.append(this.heading,this.paragraph)}render(){document.title="Fun Chat - About",this.div.append(this.homeButton.getElement()),c.append(this.div)}}class V{constructor(e){this.header=document.createElement("header");const t=document.createElement("h1");t.innerText=e,this.divWrapper=document.createElement("div"),this.divWrapper.classList.add("header-wrapper"),this.text=document.createElement("p"),this.text.classList.add("header-user"),this.text.textContent="Username: ",this.aboutBtn=new f("aboutBtn","About",()=>{new g().navigate("/about")}),this.logoutBtn=new f("logoutBtn","Log out",()=>{console.log("log out"),this.logout(),new g().navigate("/")}),this.divWrapper.append(this.text,this.aboutBtn.getElement(),this.logoutBtn.getElement()),this.header.append(t,this.divWrapper)}async logout(){const e=S();e&&await P(e.login,e.password)}appendTo(e){e.appendChild(this.header)}getElement(){return this.header}setUser(e){this.text.textContent=`Username: ${e}`}}const Q=new V("Fun Chat"),Y="data:image/png;base64,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";class H{constructor(){this.div=document.createElement("div"),this.div.classList.add("footer"),this.logoContainer=document.createElement("a"),this.logoContainer.classList.add("footer-logo-wrapper"),this.logoContainer.href="https://rs.school/",this.logoContainer.target="_blank",this.logo=document.createElement("img"),this.logo.src=Y,this.logo.alt="RS School Logo",this.logo.width=25,this.logo.height=25,this.logoText=document.createElement("p"),this.logoText.classList.add("footer-logo-text"),this.logoText.textContent="RS School",this.logoContainer.append(this.logo,this.logoText),this.link=document.createElement("a"),this.link.href="https://github.com/thefoku",this.link.classList.add("footer-link"),this.link.target="_blank",this.link.textContent="thefoku",this.year=document.createElement("p"),this.year.textContent="2025",this.div.append(this.logoContainer,this.link,this.year)}getElement(){return this.div}}const j=new H;class K{constructor(){this.isAuthenticated=!1,c.create(),this.main=new C,this.header=Q,this.footer=j,this.chatBody=document.createElement("div"),this.chatBody.classList.add("chat-wrapper"),this.usersList=L,this.usersList.clear(),this.chatBody.append(this.usersList.getElement(),d.getElement()),this.main.append(this.header.getElement(),this.chatBody,this.footer.getElement(),w.getElement()),this.reLogin(),this.loadAllUsers()}render(){u.Users.length=0,document.title="Fun Chat - Chat",a.targetUser=null,this.usersList.clear(),d.clearChat(),d.clearSelectedUser(),c.append(this.main.getElement())}async reLogin(){const e=S();if(!(e!=null&&e.isLogined)||!e.login||!e.password){c.removeChildren(),setTimeout(()=>{new g().navigate("/"),w.showWithText("Please, log in first.")});return}try{if(await a.ensureConnection(),a.isCurrentUser(e.login)){console.log(e.login,"current user"),a.currentUser&&this.header.setUser(a.currentUser),this.isAuthenticated=!0;return}if((await a.authenticate(e.login,e.password)).payload.user.isLogined)a.currentUser&&this.header.setUser(a.currentUser),this.isAuthenticated=!0;else throw new Error("Login failed")}catch(t){console.error("Re-login error:",t),this.isAuthenticated=!1}}async loadAllUsers(){try{await a.ensureConnection();const[e,t]=await Promise.all([a.getActiveUsers(),a.getInactiveUsers()])}catch(e){console.error("Error when receiving users list:",e)}}}const p=class p{constructor(){this.routes={},this.currentUrl=window.location.pathname,this.isRouting=!1,this.handlePopState=this.handlePopState.bind(this),p.isEventAdded||(window.addEventListener("popstate",this.handlePopState),p.isEventAdded=!0)}handlePopState(){if(this.isRouting)return;this.isRouting=!0;const e=window.location.pathname;this.currentUrl!==e&&(p.previousUrl=this.currentUrl,this.currentUrl=e,this.route()),this.isRouting=!1}addRoute(e,t){this.routes[e]=t}navigate(e){this.currentUrl!==e&&(p.previousUrl=this.currentUrl,history.pushState({},"",e),this.currentUrl=e,this.route())}goBack(){p.previousUrl?this.navigate(p.previousUrl):this.navigate("/")}getLocation(){return window.location.pathname}route(){const e=window.location.pathname;if(e==="/about")new W().render();else if(e==="/"||e==="/index.html"){new J().render();return}else e==="/chat"?new K().render():new R().render()}};p.previousUrl=null,p.isEventAdded=!1;let g=p;const z=new g;z.route();
